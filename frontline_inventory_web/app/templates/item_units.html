{% extends "base.html" %}
{% block content %}

<h1 class="text-xl font-semibold mb-3">{{ item.name }} <span class="text-zinc-500 text-base">({{ item.sku }})</span></h1>

{% if customers is defined %}
  <div class="text-xs text-zinc-500 mb-2">Kunder i render: {{ customers|length }}</div>
{% else %}
  <div class="text-xs text-rose-600 mb-2">customers IKKE i context</div>
{% endif %}
<div data-probe="ITEM-DETAIL-TEMPLATE-AKTIV" class="hidden"></div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
  <div class="rounded-2xl border p-4 bg-white">
    <div class="text-sm text-zinc-600">Ledig</div>
    <div class="text-2xl font-bold">{{ count_avail }}</div>
  </div>
  <div class="rounded-2xl border p-4 bg-white">
    <div class="text-sm text-zinc-600">Reservert</div>
    <div class="text-2xl font-bold">{{ count_res }}</div>
  </div>
  <div class="rounded-2xl border p-4 bg-white">
    <div class="text-sm text-zinc-600">Brukt</div>
    <div class="text-2xl font-bold">{{ count_used }}</div>
  </div>
</div>

<form method="post" action="/item/{{ item.id }}/reserve_customer" class="flex gap-3 items-end mb-3">
  <div class="flex-1">
    <label class="block text-sm text-gray-600">Kunde</label>
    <select id="customer_select" name="customer_id" class="px-3 py-2 rounded border w-full" required>
  <option value="" disabled selected>Velg kunde…</option>
  {% if customers is defined %}
    {% for c in customers %}
      <option value="{{ c.id }}">{{ c.name }}{% if c.email %} – {{ c.email }}{% endif %}</option>
    {% endfor %}
  {% endif %}
</select>
  </div>

<script>
(async () => {
  const sel = document.getElementById('customer_select');
  if (!sel) return;

  // Hvis templaten IKKE fikk kunder i context, henter vi dem via API:
  const hasServerOptions = sel.querySelectorAll('option').length > 1;
  if (hasServerOptions) return; // allerede fylt av server

  try {
    const res = await fetch('/api/customers', { credentials: 'same-origin' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json(); // [{id,name,email}, ...]

    // Tøm bort “Velg kunde…” og legg den inn igjen på topp:
    const first = sel.querySelector('option');
    sel.innerHTML = '';
    sel.appendChild(first);

    for (const c of data) {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.email ? `${c.name} – ${c.email}` : c.name;
      sel.appendChild(opt);
    }
  } catch (err) {
    console.error('Kunne ikke hente kunder:', err);
  }
})();
</script>

  <div>
    <label class="block text-sm text-gray-600">Antall</label>
    <input type="number" min="1" name="qty" value="1" class="px-3 py-2 rounded border" />
  </div>

  <div class="flex-1">
    <label class="block text-sm text-gray-600">Notat</label>
    <input type="text" name="note" value="Reservasjon" class="px-3 py-2 rounded border w-full" />
  </div>

  <button class="px-3 py-2 rounded bg-zinc-900 text-white">Reserver</button>
</form>

<div class="rounded-2xl border p-4 bg-white mb-4">
  <h2 class="font-semibold mb-2">Mottak (opprett enheter)</h2>
  <form method="post" action="/item/{{ item.id }}/units/receive" class="flex gap-2 items-end">
    <div>
      <label class="block text-sm text-zinc-600">Antall</label>
      <input type="number" name="qty" min="1" value="1" class="px-3 py-2 rounded border" required>
    </div>
    <div>
      <label class="block text-sm text-zinc-600">Bestillingsordre (PO-kode)</label>
      <input type="text" name="po_code" placeholder="PO-2025-001" class="px-3 py-2 rounded border" required>
    </div>
    <div class="flex-1">
      <label class="block text-sm text-zinc-600">Notat</label>
      <input type="text" name="note" value="Mottak" class="px-3 py-2 rounded border w-full">
    </div>
    <button class="px-3 py-2 rounded bg-zinc-900 text-white">+ Opprett</button>
  </form>
</div>

<div class="rounded-2xl border bg-white overflow-hidden">
  <div class="p-3 flex items-center justify-between">
    <div class="text-sm text-zinc-600">Enheter</div>
    <div class="flex gap-2">
      <form id="reserveForm" method="post" action="/item/{{ item.id }}/units/reserve" class="flex items-center gap-2">
        <input type="hidden" name="unit_ids" id="reserve_ids">
        <input type="text" name="co_code" placeholder="CO-2025-001" class="px-3 py-2 rounded border" required>
        <input type="text" name="note" value="Reservert" class="px-3 py-2 rounded border">
        <button class="px-3 py-2 rounded border">Reserver</button>
      </form>
      <form id="unreserveForm" method="post" action="/item/{{ item.id }}/units/unreserve" class="flex items-center gap-2">
        <input type="hidden" name="unit_ids" id="unreserve_ids">
        <input type="text" name="note" value="Opphevet reservasjon" class="px-3 py-2 rounded border">
        <button class="px-3 py-2 rounded border">Opphev reservasjon</button>
      </form>
      <form id="issueForm" method="post" action="/item/{{ item.id }}/units/issue" class="flex items-center gap-2">
        <input type="hidden" name="unit_ids" id="issue_ids">
        <input type="text" name="co_code" placeholder="CO-2025-001" class="px-3 py-2 rounded border" required>
        <input type="text" name="note" value="Uttak" class="px-3 py-2 rounded border">
        <button class="px-3 py-2 rounded bg-rose-600 text-white">Uttak</button>
      </form>
    </div>
  </div>
  <table class="w-full text-sm">
    <thead class="bg-zinc-100">
      <tr class="text-left">
        <th class="p-2"><input type="checkbox" id="allToggle"></th>
        <th class="p-2">ID</th>
        <th class="p-2">Status</th>
        <th class="p-2">PO</th>
        <th class="p-2">Reservasjon (CO)</th>
        <th class="p-2">Opprettet</th>
        <th class="p-2">Brukt</th>
      </tr>
    </thead>
    <tbody>
      {% for u in units %}
      <tr class="odd:bg-zinc-50">
        <td class="p-2"><input type="checkbox" class="rowcb" value="{{ u.id }}" {% if u.status == 'used' %}disabled{% endif %}></td>
        <td class="p-2">{{ u.id }}</td>
        <td class="p-2">
          {% if u.status == 'available' %}<span class="text-emerald-700 font-medium">ledig</span>
          {% elif u.status == 'reserved' %}<span class="text-amber-700 font-medium">reservert</span>
          {% else %}<span class="text-rose-700 font-medium">brukt</span>{% endif %}
        </td>
        <td class="p-2">{% if u.po %}{{ u.po.code }}{% endif %}</td>
        <td class="p-2">{% if u.reserved_co %}{{ u.reserved_co.code }}{% endif %}</td>
        <td class="p-2 whitespace-nowrap">{{ u.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td class="p-2 whitespace-nowrap">{% if u.used_at %}{{ u.used_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}</td>
      </tr>
      {% endfor %}
      {% if units|length == 0 %}
      <tr><td class="p-3 text-zinc-500" colspan="7">Ingen enheter registrert ennå.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
  const allToggle = document.getElementById('allToggle');
  const cbs = Array.from(document.querySelectorAll('.rowcb'));
  function selectedIds() { return cbs.filter(cb => cb.checked).map(cb => cb.value).join(','); }
  allToggle?.addEventListener('change', () => cbs.forEach(cb => { if(!cb.disabled) cb.checked = allToggle.checked; }));
  function wire(formId, hiddenId) {
    const f = document.getElementById(formId);
    const h = document.getElementById(hiddenId);
    if(!f || !h) return;
    f.addEventListener('submit', (e) => {
      const ids = selectedIds();
      if(!ids) { e.preventDefault(); alert('Velg minst én enhet.'); return; }
      h.value = ids;
    });
  }
  wire('reserveForm','reserve_ids');
  wire('unreserveForm','unreserve_ids');
  wire('issueForm','issue_ids');
</script>

{% endblock %}
