{% extends "base.html" %}
{% block content %}
{% if error %}
<div class="mb-3 p-3 rounded border border-amber-300 bg-amber-50 text-amber-900">
  {{ error }}
</div>
{% endif %}
<!-- Mobil: hele filteret stables i høyden -->
<form class="sm:hidden mb-4 grid grid-cols-1 gap-2" method="get" action="/">
  <input class="w-full px-3 py-2 rounded-lg border border-zinc-300" name="q" value="{{ q }}" placeholder="Søk navn, SKU, notater">
  <label class="grid gap-1">
    <span class="text-xs text-zinc-500">Kategori</span>
    <select class="w-full px-3 py-2 rounded-lg border border-zinc-300" name="category">
      <option {% if category=='Alle' %}selected{% endif %}>Alle</option>
      {% for c in cats %}<option {% if category==c %}selected{% endif %}>{{ c }}</option>{% endfor %}
    </select>
  </label>
  <label class="grid gap-1">
    <span class="text-xs text-zinc-500">Lokasjon</span>
    <select class="w-full px-3 py-2 rounded-lg border border-zinc-300" name="location">
      <option {% if location=='Alle' %}selected{% endif %}>Alle</option>
      {% for l in locs %}<option {% if location==l %}selected{% endif %}>{{ l }}</option>{% endfor %}
    </select>
  </label>
  <label class="grid gap-1">
    <span class="text-xs text-zinc-500">Sortering</span>
    <select class="w-full px-3 py-2 rounded-lg border border-zinc-300" name="sort">
      <option value="name" {% if sort=='name' %}selected{% endif %}>Navn</option>
      <option value="qty" {% if sort=='qty' %}selected{% endif %}>Antall</option>
      <option value="value" {% if sort=='value' %}selected{% endif %}>Lagerverdi</option>
      <option value="sku" {% if sort=='sku' %}selected{% endif %}>SKU</option>
    </select>
  </label>
  <div class="grid grid-cols-2 gap-2">
    <button class="px-3 py-2 rounded-lg bg-zinc-900 text-white" type="submit">Filtrer</button>
    <a href="/" class="px-3 py-2 rounded-lg border border-zinc-300 text-center">Nullstill</a>
  </div>
</form>
<!-- Mobil: søkefelt + filterknapp -->
<div class="hidden sm:hidden mb-3 flex gap-2 w-full">
  <input class="flex-1 px-3 py-2 rounded-lg border border-zinc-300" name="q" form="filter-form" value="{{ q }}" placeholder="Søk navn, SKU, notater">
  <button id="open-filters" class="px-3 py-2 rounded-lg border border-zinc-300">Filtre</button>
  <button class="px-3 py-2 rounded-lg bg-zinc-900 text-white" type="submit" form="filter-form">Søk</button>
  <a href="/" class="px-3 py-2 rounded-lg border border-zinc-300" title="Nullstill">Nullstill</a>
  </div>

<!-- Mobil filter-drawer -->
<div id="filters-drawer" class="sm:hidden fixed inset-0 z-30 hidden">
  <div class="absolute inset-0 bg-black/30" data-close></div>
  <div class="absolute right-0 top-0 bottom-0 w-[85%] max-w-sm bg-white shadow-xl p-4 flex flex-col">
    <div class="flex items-center mb-3">
      <div class="font-semibold text-lg">Filtre</div>
      <button class="ml-auto px-3 py-1.5 rounded border" data-close>Lukk</button>
    </div>
    <div class="grid gap-3">
      <label class="grid gap-1">
        <span class="text-xs text-zinc-500">Kategori</span>
        <select class="px-3 py-2 rounded-lg border border-zinc-300" name="category" form="filter-form">
          <option {% if category=='Alle' %}selected{% endif %}>Alle</option>
          {% for c in cats %}<option {% if category==c %}selected{% endif %}>{{ c }}</option>{% endfor %}
        </select>
      </label>
      <label class="grid gap-1">
        <span class="text-xs text-zinc-500">Lokasjon</span>
        <select class="px-3 py-2 rounded-lg border border-zinc-300" name="location" form="filter-form">
          <option {% if location=='Alle' %}selected{% endif %}>Alle</option>
          {% for l in locs %}<option {% if location==l %}selected{% endif %}>{{ l }}</option>{% endfor %}
        </select>
      </label>
      <label class="grid gap-1">
        <span class="text-xs text-zinc-500">Sortering</span>
        <select class="px-3 py-2 rounded-lg border border-zinc-300" name="sort" form="filter-form">
          <option value="name" {% if sort=='name' %}selected{% endif %}>Navn</option>
          <option value="qty" {% if sort=='qty' %}selected{% endif %}>Antall</option>
          <option value="value" {% if sort=='value' %}selected{% endif %}>Lagerverdi</option>
          <option value="sku" {% if sort=='sku' %}selected{% endif %}>SKU</option>
        </select>
      </label>
      <div class="mt-2 flex gap-2">
        <button class="flex-1 px-3 py-2 rounded-lg bg-zinc-900 text-white" type="submit" form="filter-form">Bruk</button>
        <a class="flex-1 px-3 py-2 rounded-lg border border-zinc-300 text-center" href="/">Nullstill</a>
      </div>
    </div>
  </div>
</div>

<!-- Nøkkeltall (mobil: store kort) -->
<div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
  <div class="rounded-2xl border bg-white p-4">
    <div class="text-sm text-zinc-600">Ledig</div>
    <div class="text-2xl font-bold text-emerald-700">{{ total_available }}</div>
  </div>
  <div class="rounded-2xl border bg-white p-4">
    <div class="text-sm text-zinc-600">Reservert</div>
    <div class="text-2xl font-bold text-amber-700">{{ total_reserved }}</div>
  </div>
  <div class="rounded-2xl border bg-white p-4 col-span-2 sm:col-span-1">
    <div class="text-sm text-zinc-600">Lav beholdning</div>
    <div class="text-2xl font-bold text-rose-700">{{ low_count }}</div>
  </div>
</div>
<form id="filter-form" class="hidden sm:grid md:grid-cols-3 gap-2 items-end mb-4" method="get" action="/">
  <label class="grid gap-1 md:col-span-2">
    <span class="text-xs text-zinc-500">Søk</span>
    <input class="px-3 py-2 rounded-lg border border-zinc-300" name="q" value="{{ q }}" placeholder="Søk navn, SKU, notater">
  </label>
  <div class="grid grid-cols-3 gap-2">
    <label class="grid gap-1">
      <span class="text-xs text-zinc-500">Kategori</span>
      <select class="px-3 py-2 rounded-lg border border-zinc-300" name="category">
        <option {% if category=='Alle' %}selected{% endif %}>Alle</option>
        {% for c in cats %}<option {% if category==c %}selected{% endif %}>{{ c }}</option>{% endfor %}
      </select>
    </label>
    <label class="grid gap-1">
      <span class="text-xs text-zinc-500">Lokasjon</span>
      <select class="px-3 py-2 rounded-lg border border-zinc-300" name="location">
                <option {% if location=='Alle' %}selected{% endif %}>Alle</option>
        {% for l in locs %}<option {% if location==l %}selected{% endif %}>{{ l }}</option>{% endfor %}
      </select>
    </label>
    <label class="grid gap-1">
      <span class="text-xs text-zinc-500">Sortering</span>
      <select class="px-3 py-2 rounded-lg border border-zinc-300" name="sort">
        <option value="name" {% if sort=='name' %}selected{% endif %}>Navn</option>
        <option value="qty" {% if sort=='qty' %}selected{% endif %}>Antall</option>
        <option value="value" {% if sort=='value' %}selected{% endif %}>Lagerverdi</option>
        <option value="sku" {% if sort=='sku' %}selected{% endif %}>SKU</option>
      </select>
    </label>
  </div>
  <div class="md:col-span-3 flex items-center gap-2">
    <button class="px-3 py-2 rounded-lg bg-zinc-900 text-white" type="submit">Filtrer</button>
    <a href="/" class="px-3 py-2 rounded-lg border border-zinc-300">Nullstill</a>
    <div class="ml-auto grid grid-cols-3 gap-3 text-sm">
      <div><div class="text-xs text-zinc-500">Unike varer</div><div class="font-semibold">{{ total_items }}</div></div>
      <div><div class="text-xs text-zinc-500">Lagerverdi</div><div class="font-semibold">{{ fmt_currency(total_value) }} NOK</div></div>
      <div><div class="text-xs text-zinc-500">MVA 25% (hint)</div><div class="font-semibold">{{ fmt_currency(total_value*0.25) }} NOK</div></div>
    </div>
  </div>
</form>

<!-- Mobil kortvisning -->
<div class="sm:hidden space-y-3">
  {% for i in items %}
  {% set avail = (avail_counts[i.id] if avail_counts and i.id in avail_counts else 0) %}
  <div class="rounded-lg border border-zinc-200 bg-white p-4">
    <div class="font-medium mb-1">{{ i.name }}</div>
    <div class="text-sm">Status:
      {% if avail <= 0 %}
        <span class="text-rose-700 font-medium">Tomt</span>
      {% elif avail <= i.min_qty %}
        <span class="text-amber-700 font-medium">Lav beholdning</span>
      {% else %}
        <span class="text-emerald-700 font-medium">Ledig</span>
      {% endif %}
    </div>
    <div class="text-sm">Antall: {{ i.qty }}</div>
    <a href="/item/{{ i.id }}/units" class="mt-2 inline-block px-3 py-2 rounded bg-zinc-900 text-white text-sm">Se detaljer</a>
  </div>
  {% endfor %}
  {% if items|length == 0 %}
  <div class="p-3 text-zinc-500">Ingen varer funnet.</div>
  {% endif %}
</div>

<!-- Desktop tabellvisning -->
<div class="hidden sm:block rounded-2xl border border-zinc-200 overflow-hidden bg-white">
  <table class="w-full text-sm">
    <thead class="bg-zinc-100">
      <tr class="text-left">
        <th class="p-2">Vare</th>
        <th class="p-2">SKU</th>
        <th class="p-2">Kategori</th>
        <th class="p-2">Lokasjon</th>
        <th class="p-2">Antall</th>
        <th class="p-2">Min.</th>
        <th class="p-2">Pris</th>
        <th class="p-2">Verdi</th>
        <th class="p-2 w-48">Handling</th>
      </tr>
    </thead>
    <tbody>
      {% for i in items %}
      <tr class="odd:bg-zinc-50 align-top cursor-pointer hover:bg-zinc-100" ondblclick="window.location.href='/item/{{ i.id }}/units'">
        <td class="p-2">
          <div class="font-medium flex items-center gap-2">
            {% set avail = (avail_counts[i.id] if avail_counts and i.id in avail_counts else 0) %}
            {% if avail <= 0 or avail <= i.min_qty %}<span class="inline-block w-2 h-2 rounded-full bg-rose-500" title="Lav beholdning"></span>{% endif %}
            {% if i.image_path %}<img src="{{ i.image_path }}" class="w-16 h-16 object-cover rounded">{% endif %}
            {{ i.name }}
          </div>
          <div class="text-xs text-zinc-500">{{ i.notes }}</div>
        </td>
        <td class="p-2">{{ i.sku }}</td>
        <td class="p-2">{{ i.category_obj.name if i.category_obj else '' }}</td>
        <td class="p-2">{{ i.location_obj.name if i.location_obj else '' }}</td>
        <td class="p-2 font-semibold">{{ i.qty }}</td>
        <td class="p-2">{{ i.min_qty }}</td>
        <td class="p-2">{{ i.price|round(2) }} {{ i.currency }}</td>
        <td class="p-2">{{ (i.price * i.qty)|round(2) }} {{ i.currency }}</td>
        <td class="p-2">
          <form hx-post="/item/{{ i.id }}/adjust" hx-include="closest tr" class="flex items-center gap-1 mb-1">
            <input type="hidden" name="note" value="Justering +">
            <input class="w-16 px-2 py-1 rounded border border-zinc-300" name="delta" type="number" value="1">
            <button class="px-2 py-1 rounded border border-zinc-300" type="submit">+ Legg til</button>
          </form>
          <form hx-post="/item/{{ i.id }}/adjust" hx-include="closest tr" class="flex items-center gap-1 mb-2">
            <input type="hidden" name="note" value="Justering -">
            <input class="w-16 px-2 py-1 rounded border border-zinc-300" name="delta" type="number" value="-1">
            <button class="px-2 py-1 rounded border border-zinc-300" type="submit">- Trekk</button>
          </form>
          <div class="flex items-center gap-2">
            <a href="/item/{{ i.id }}/edit" class="px-2 py-1 rounded border border-zinc-300">Rediger</a>
            <form action="/item/{{ i.id }}/delete" method="post" class="inline-flex items-center gap-2" onsubmit="return confirm('Slette {{ i.name }}? Dette kan ikke angres.');">
              <input name="confirm" class="px-2 py-1 rounded border text-xs" placeholder="skriv 1234" required>
              <button class="px-2 py-1 rounded bg-rose-600 text-white text-xs">Slett</button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
      {% if items|length == 0 %}
      <tr><td class="p-3 text-zinc-500" colspan="9">Ingen varer funnet.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
{% set pages = (total // per_page) + (1 if total % per_page else 0) %}
{% if pages > 1 %}
<div class="mt-3 flex items-center gap-2">
  {% for p in range(1, pages+1) %}
    <a href="/?q={{ q }}&category={{ category }}&location={{ location }}&sort={{ sort }}&page={{ p }}&per_page={{ per_page }}"
       class="px-2 py-1 rounded border {% if p==page %}bg-zinc-900 text-white{% else %}border-zinc-300{% endif %}">{{ p }}</a>
  {% endfor %}
  <div class="ml-auto text-xs text-zinc-500">{{ total }} totalt</div>
</div>
{% endif %}



{% endblock %}

{% block fab %}
<a href="/item/new" class="w-14 h-14 rounded-full bg-zinc-900 text-white flex items-center justify-center text-3xl shadow-lg">+</a>
{% endblock %}
