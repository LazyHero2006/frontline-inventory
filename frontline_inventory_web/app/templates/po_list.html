{% extends "base.html" %}
{% block content %}
<h1 class="text-xl font-semibold mb-3">Leverandørordre</h1>

<section class="rounded-2xl border border-zinc-200 bg-white p-3 mb-4">
  <form method="get" action="/po" class="flex flex-wrap gap-2 items-end mb-3">
    <div>
      <label class="block text-xs text-zinc-600">Søk</label>
      <input name="q" value="{{ q or '' }}" class="px-2 py-1 rounded border w-64" placeholder="Søk kode/leverandør">
    </div>
    <div>
      <label class="block text-xs text-zinc-600">Sorter</label>
      <select name="sort" class="px-2 py-1 rounded border">
        <option value="newest" {% if sort=='newest' %}selected{% endif %}>Nyest først</option>
        <option value="oldest" {% if sort=='oldest' %}selected{% endif %}>Eldst først</option>
      </select>
    </div>
    <button class="px-3 py-1.5 rounded border">Filtrer</button>
  </form>
  <form method="post" action="/po/new" enctype="multipart/form-data" class="flex flex-wrap gap-2 items-end">
    <div>
      <label class="block text-xs text-zinc-600">PO-kode</label>
      <input name="code" class="px-2 py-1 rounded border w-48" placeholder="PO-2025-001" required>
    </div>
    <div>
      <label class="block text-xs text-zinc-600">Leverandør</label>
      <input name="supplier" class="px-2 py-1 rounded border w-64" placeholder="Leverandørnavn">
    </div>
    <div>
      <label class="block text-xs text-zinc-600">Vedlegg (PDF)</label>
      <input type="file" name="pdf" accept="application/pdf" class="px-2 py-1 rounded border w-64">
    </div>
    <button class="px-3 py-1.5 rounded border">+ Ny PO</button>
  </form>
</section>

{% if pos and pos|length == 0 %}
  <div class="rounded-xl border border-zinc-200 bg-white p-4 text-zinc-600">Ingen PO-er enda.</div>
{% endif %}

{% if pos %}
  <div class="space-y-4">
    {% for p in pos %}
    <section class="rounded-2xl border border-zinc-200 bg-white">
      <div class="p-3 flex items-center gap-2 border-b border-zinc-100">
        <div class="font-semibold">{{ p.po.code }}</div>
        <div class="text-sm text-zinc-600">{{ p.po.supplier }}</div>
        {% if p.po.pdf_path %}<a class="text-xs underline" href="{{ p.po.pdf_path }}" target="_blank">PDF</a>{% endif %}
        <form method="post" action="/po/{{ p.po.id }}/archive" class="ml-2">
          <button class="px-2 py-1 rounded border text-xs" title="Flytt til arkiv">Arkiver</button>
        </form>
        <div class="ml-auto text-sm text-zinc-700">Gjenstår: <b>{{ p.total_remaining }}</b></div>
      </div>
      <div class="p-3 border-b border-zinc-100">
        <form method="post" action="/po/{{ p.po.id }}/line/add" class="flex flex-wrap gap-2 items-end">
          <div>
            <label class="block text-xs text-zinc-600">SKU</label>
            <input name="sku" class="px-2 py-1 rounded border w-40" placeholder="Søk SKU" required>
          </div>
          <div>
            <label class="block text-xs text-zinc-600">Antall</label>
            <input type="number" name="qty" min="1" value="1" class="px-2 py-1 rounded border w-24" required>
          </div>
          <button class="px-3 py-1.5 rounded border">+ Linje</button>
        </form>
        {% if p.po.pdf_path %}
          <div class="mt-2 text-xs"><a class="underline" href="{{ p.po.pdf_path }}" target="_blank">Åpne vedlagt PDF</a></div>
        {% endif %}
      </div>
      <table class="w-full text-sm">
        <thead class="bg-zinc-100">
          <tr>
            <th class="p-2 text-left">Vare</th>
            <th class="p-2 text-right">Bestilt</th>
            <th class="p-2 text-right">Mottatt</th>
            <th class="p-2 text-right">Gjenstår</th>
            <th class="p-2 text-right">Motta</th>
          </tr>
        </thead>
        <tbody>
          {% for x in p.lines %}
          <tr class="odd:bg-zinc-50">
            <td class="p-2">
              {% if x.item %}
                <a class="underline hover:no-underline" href="/item/{{ x.item.id }}/units">{{ x.item.name }}</a>
                <div class="text-xs text-zinc-500">{{ x.item.sku }}</div>
              {% else %}
                {{ x.line.item_id }}
              {% endif %}
            </td>
            <td class="p-2 text-right">{{ x.ordered }}</td>
            <td class="p-2 text-right">{{ x.received }}</td>
            <td class="p-2 text-right font-semibold">{{ x.remaining }}</td>
            <td class="p-2">
              <form method="post" action="/po/{{ p.po.id }}/receive" class="flex flex-wrap gap-2 items-center justify-end">
                <input type="hidden" name="item_id" value="{{ x.item.id if x.item else x.line.item_id }}">
                <input type="number" name="qty" value="{{ x.remaining if x.remaining>0 else 1 }}" min="1" class="w-20 px-2 py-1 rounded border" title="Antall">
                <input type="number" step="0.01" name="price" placeholder="Pris" class="w-28 px-2 py-1 rounded border" title="Innkjøpspris">
                <input type="text" name="co_code" placeholder="CO-2025-001" class="w-36 px-2 py-1 rounded border" title="CO-kode">
                <label class="inline-flex items-center gap-1 text-xs text-zinc-700"><input type="checkbox" name="auto_reserve" value="1" checked class="rounded border"> Reserver til CO</label>
                <button class="px-2 py-1 rounded border">Motta</button>
              </form>
              <form method="post" action="/po/{{ p.po.id }}/undo_receive" class="mt-1 flex flex-wrap gap-2 items-center justify-end">
                <input type="hidden" name="item_id" value="{{ x.item.id if x.item else x.line.item_id }}">
                <input type="number" name="qty" value="1" min="1" class="w-20 px-2 py-1 rounded border" title="Angre antall">
                <button class="px-2 py-1 rounded border text-rose-700 border-rose-300">Angre mottak</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
    {% endfor %}
  </div>
{% endif %}
<datalist id="items_skus">
  {% if items_for_datalist %}
    {% for it in items_for_datalist %}
      <option value="{{ it.sku }}" label="{{ it.name }}"></option>
    {% endfor %}
  {% endif %}
</datalist>
<script>
  // Knytt datalist til alle SKU-felter på denne siden
  (function(){
    var inputs = document.querySelectorAll('input[name="sku"]');
    inputs.forEach(function(inp){ inp.setAttribute('list', 'items_skus'); });
  })();
</script>
{% endblock %}
